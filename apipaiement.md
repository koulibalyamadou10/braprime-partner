# üí≥ **Documentation API - Syst√®me de Paiement BraPrime (Frontend)**

## üéØ Vue d'Ensemble

L'API de paiement BraPrime int√®gre la passerelle de paiement Lengo Pay **API v1** pour cr√©er des URLs de paiement s√©curis√©es via mobile money, cartes bancaires et autres m√©thodes de paiement populaires en Guin√©e.

### **üèóÔ∏è Architecture**

Ce projet Next.js sert de **backend API** pour votre application frontend :

- ‚úÖ **Backend API** : Expose des routes API REST
- ‚úÖ **Frontend s√©par√©** : Votre application consomme ces APIs
- ‚úÖ **Int√©gration** : Lengo Pay + Resend pour emails

---

## üîó **Endpoints Client**

### 1. **Cr√©er une URL de Paiement**
- **URL** : `POST /api/payments/lengo-pay`
- **Description** : Cr√©e une URL de paiement unique via Lengo Pay API v1

### 2. **V√©rifier le Statut des Paiements**
- **URL** : `GET /api/payments/status`
- **Description** : R√©cup√®re le statut via l'API Lengo Pay

---

## üîÑ **Flux d'Utilisation Client**

### **1. Cr√©ation de Paiement**
```
Frontend ‚Üí POST /api/payments/lengo-pay ‚Üí URL de paiement
```

### **2. Redirection vers Lengo Pay**
```
Frontend ‚Üí Redirige vers payment_url ‚Üí Page de paiement Lengo Pay
```

### **3. Retour automatique avec v√©rification**
```
Lengo Pay ‚Üí Redirige vers return_url ‚Üí Page de statut frontend
Frontend ‚Üí GET /api/payments/status ‚Üí Affiche le statut final
```

### **üéØ Flux Complet avec return_url**

```
1. Utilisateur clique "Payer" ‚Üí Page de paiement Lengo Pay
2. Utilisateur effectue le paiement ‚Üí Lengo Pay traite
3. Lengo Pay redirige automatiquement ‚Üí Votre page /payment-status
4. Votre page v√©rifie le statut ‚Üí Affiche "Paiement confirm√© !"
```

---

## üìã **1. Cr√©er une Transaction de Paiement**

### **Endpoint**
```
POST /api/payments/lengo-pay
```

### **Headers**
```http
Content-Type: application/json
```

### **Payload JSON**
```json
{
  "order_id": "uuid-de-la-commande",
  "user_id": "uuid-de-l-utilisateur",
  "amount": 15000,
  "currency": "GNF",
  "order_number": "CMD-2024-001",
  "business_name": "Restaurant Le Gourmet",
  "customer_name": "John Doe",
  "customer_email": "john@example.com"
}
```

**Note** : 
- L'API BraPrime convertit automatiquement le montant en string pour Lengo Pay selon la documentation officielle.
- L'utilisateur choisit sa m√©thode de paiement et son num√©ro directement sur la page Lengo Pay.

### **R√©ponse Succ√®s**
```json
{
  "success": true,
  "pay_id": "WTVWaTBOUXVlNTB1NXNzbUhldGF0eENSV3VkeTJuV3E=",
  "payment_url": "https://payment.lengopay.com/WTVWaTBOUXVlNTB1NXNzbUhldGF0eENSV3VkeTJuV3E=",
  "message": "URL de paiement cr√©√©e avec succ√®s",
  "data": {
    "order_id": "uuid-de-la-commande",
    "amount": 15000,
    "currency": "GNF",
    "status": "pending",
    "payment_url": "https://payment.lengopay.com/WTVWaTBOUXVlNTB1NXNzbUhldGF0eENSV3VkeTJuV3E="
  }
}
```

### **R√©ponse Erreur**
```json
{
  "error": "Donn√©es manquantes",
  "required": ["order_id", "user_id", "amount", "phone_number"]
}
```

### **cURL Example**
```bash
curl -X POST http://localhost:3000/api/payments/lengo-pay \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "uuid-de-la-commande",
    "user_id": "uuid-de-l-utilisateur",
    "amount": 15000,
    "currency": "GNF",
    "order_number": "CMD-2024-001",
    "business_name": "Restaurant Le Gourmet",
    "customer_name": "John Doe",
    "customer_email": "john@example.com"
  }'
```

---

## üìã **2. V√©rifier le Statut des Paiements**

### **Endpoint**
```
GET /api/payments/status
```

### **Param√®tres de Requ√™te**
| Param√®tre | Type | Description | Exemple |
|-----------|------|-------------|---------|
| `pay_id` | string | ID sp√©cifique du paiement | `WWVrc0wwWFBoaGpob3hZeVY5SmpzY3hDU0lUYVdPdE8=` |
| `order_id` | string | ID de la commande | `uuid-de-la-commande` |
| `user_id` | string | ID de l'utilisateur | `uuid-de-l-utilisateur` |
| `status` | string | Statut du paiement | `success`, `pending`, `failed` |
| `limit` | number | Nombre de r√©sultats | `10` |
| `offset` | number | Pagination | `0` |

### **R√©ponse Succ√®s (Paiement Sp√©cifique)**
```json
{
  "success": true,
  "data": {
    "id": "pay_WWVrc0wwWFBoaGpob3hZeVY5SmpzY3hDU0lUYVdPdE8=",
    "order_id": "order_123",
    "pay_id": "WWVrc0wwWFBoaGpob3hZeVY5SmpzY3hDU0lUYVdPdE8=",
    "amount": 1000,
    "currency": "GNF",
    "status": "initiated",
    "method": "lengo-pay",
    "created_at": "2025-07-25 13:18:53",
    "updated_at": "2025-07-25 13:18:53",
    "gateway_response": {
      "status": "INITIATED",
      "pay_id": "WWVrc0wwWFBoaGpob3hZeVY5SmpzY3hDU0lUYVdPdE8=",
      "date": "2025-07-25 13:18:53",
      "amount": 1000
    }
  },
  "source": "lengo-pay-api"
}
```

### **cURL Examples**

#### V√©rifier un paiement sp√©cifique
```bash
curl -X GET "http://localhost:3000/api/payments/status?pay_id=WWVrc0wwWFBoaGpob3hZeVY5SmpzY3hDU0lUYVdPdE8="
```

#### Lister les paiements d'un utilisateur
```bash
curl -X GET "http://localhost:3000/api/payments/status?user_id=uuid-de-l-utilisateur&status=success&limit=5"
```

#### Lister tous les paiements avec pagination
```bash
curl -X GET "http://localhost:3000/api/payments/status?limit=10&offset=0"
```

---

## üöÄ **Impl√©mentation C√¥t√© Client**

### **√âtapes d'Impl√©mentation**

1. **Cr√©er la page de statut** : `/payment-status`
2. **Configurer les variables d'environnement** : `FRONTEND_RETURN_URL`
3. **Tester le flux complet** : Cr√©ation ‚Üí Paiement ‚Üí Retour
4. **Personnaliser l'interface** : Styles et messages

### **üéØ Page de Statut Frontend (Obligatoire)**

Vous devez cr√©er une page `/payment-status` dans votre frontend pour recevoir l'utilisateur apr√®s le paiement :

```javascript
// pages/payment-status.js ou components/PaymentStatusPage.js
import React, { useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation';

const PaymentStatusPage = () => {
  const searchParams = useSearchParams();
  const [status, setStatus] = useState('checking');
  const [message, setMessage] = useState('V√©rification du paiement...');

  useEffect(() => {
    const orderId = searchParams.get('order_id');
    const payId = searchParams.get('pay_id');

    if (orderId && payId) {
      // V√©rifier le statut du paiement
      checkPaymentStatus(payId);
    } else {
      setStatus('error');
      setMessage('Param√®tres manquants');
    }
  }, [searchParams]);

  const checkPaymentStatus = async (payId) => {
    try {
      const response = await fetch(`/api/payments/status?pay_id=${payId}`);
      const data = await response.json();

      if (data.success) {
        const paymentStatus = data.data.status;
        
        switch (paymentStatus) {
          case 'success':
          case 'SUCCESS':
            setStatus('success');
            setMessage('‚úÖ Paiement confirm√© ! Votre commande est en cours de pr√©paration.');
            break;
          case 'failed':
          case 'FAILED':
            setStatus('failed');
            setMessage('‚ùå Paiement √©chou√©. Veuillez r√©essayer.');
            break;
          case 'initiated':
          case 'INITIATED':
            setStatus('pending');
            setMessage('‚è≥ Paiement en cours... Veuillez patienter.');
            // Continuer le polling
            setTimeout(() => checkPaymentStatus(payId), 5000);
            break;
          default:
            setStatus('unknown');
            setMessage('‚ÑπÔ∏è Statut inconnu');
        }
      } else {
        setStatus('error');
        setMessage('‚ùå Erreur de v√©rification');
      }
    } catch (error) {
      console.error('Erreur v√©rification statut:', error);
      setStatus('error');
      setMessage('‚ùå Erreur de connexion');
    }
  };

  return (
    <div className="payment-status-page">
      <div className={`status-container ${status}`}>
        <h1>Statut du Paiement</h1>
        <div className="status-message">{message}</div>
        
        {status === 'success' && (
          <div className="success-actions">
            <button onClick={() => window.location.href = '/'}>
              Retour √† l'accueil
            </button>
          </div>
        )}
        
        {status === 'failed' && (
          <div className="failed-actions">
            <button onClick={() => window.history.back()}>
              R√©essayer
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default PaymentStatusPage;
```

### **Exemple d'Int√©gration Compl√®te**

```javascript
// 1. Page de commande (cr√©ation du paiement)
const OrderPage = () => {
  const createPayment = async (orderData) => {
    const response = await fetch('/api/payments/lengo-pay', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Rediriger vers Lengo Pay
      window.location.href = result.payment_url;
    }
  };

  return (
    <div>
      <button onClick={() => createPayment(orderData)}>
        Payer maintenant
      </button>
    </div>
  );
};

// 2. Page de statut (return_url)
const PaymentStatusPage = () => {
  // ... code de la page de statut (voir plus haut)
};
```

### **Configuration Requise**

```env
# Dans votre frontend (.env.local)
NEXT_PUBLIC_API_URL=http://localhost:3000
FRONTEND_RETURN_URL=http://localhost:8080/payment-status
```

### **üîó Configuration du return_url**

Le `return_url` est automatiquement configur√© dans l'API BraPrime :

```javascript
// Dans l'API BraPrime (app/api/payments/lengo-pay/route.ts)
const requestData = {
  websiteid: LENGO_PAY_CONFIG.websiteId!,
  currency: paymentData.currency,
  amount: Number(paymentData.amount),
  return_url: `${LENGO_PAY_CONFIG.returnUrl}?order_id=${paymentData.order_id}&pay_id=${paymentData.order_id}`,
  callback_url: `${LENGO_PAY_CONFIG.callbackBaseUrl}?order_id=${paymentData.order_id}`
};
```

**URLs configur√©es :**
- **D√©veloppement** : `http://localhost:8080/payment-status`
- **Production** : `https://votre-domaine.com/payment-status`

---

## üîß **Configuration**

### **Variables d'Environnement Configur√©es**

Vos cl√©s Lengo Pay sont d√©j√† configur√©es dans le fichier `.env.local` :

```env
# Configuration Lengo Pay
LENGO_PAY_LICENSE_KEY=MXNuTGhqVmc2eExqaE5vYlhUaEpONmRUMFg3eTFJbWlJN1hQdFg2T3A3U0gydHhKUWpLbHRrTWhJVDM1Q202Mw==
LENGO_PAY_WEBSITE_ID=DRclgwGVrQz4Tw0x
LENGO_PAY_CALLBACK_URL=http://localhost:3000/api/payments/lengo-pay/callback
FRONTEND_RETURN_URL=http://localhost:8080/payment-status

# Configuration Resend (pour les emails)
RESEND_API_KEY=votre_cle_api_resend

# Configuration Admin
ADMIN_EMAILS=admin@bradelivery.com,manager@bradelivery.com
SUPPORT_EMAIL=support@bradelivery.com
SUPPORT_PHONE=+224 621 00 00 00
```

### **M√©thodes de Paiement Support√©es**

| M√©thode | Code | Description |
|---------|------|-------------|
| Orange Money Guin√©e | `lp-om-gn` | Paiement via Orange Money |
| MTN Mobile Money | `lp-momo-gn` | Paiement via MTN MoMo |
| Visa | `lp-visa` | Paiement par carte Visa |
| Mastercard | `lp-mastercard` | Paiement par carte Mastercard |

---

## üß™ **Tests**

### **Test de Cr√©ation de Paiement**

```javascript
// Test avec fetch
fetch('http://localhost:3000/api/payments/lengo-pay', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    order_id: 'test-order-123',
    user_id: 'test-user-456',
    amount: 15000,
    currency: 'GNF',
    order_number: 'CMD-TEST-001',
    business_name: 'Restaurant Test',
    customer_name: 'Test User',
    customer_email: 'test@example.com'
  })
})
.then(response => response.json())
.then(data => console.log('Success:', data))
.catch(error => console.error('Error:', error));
```

### **Test de V√©rification de Statut**

```javascript
// V√©rifier le statut d'un paiement
fetch('http://localhost:3000/api/payments/status?pay_id=test-pay-id')
.then(response => response.json())
.then(data => console.log('Status:', data))
.catch(error => console.error('Error:', error));
```



## üìù **Notes Importantes**

1. **Test en D√©veloppement** : Utilisez des num√©ros de t√©l√©phone de test
2. **Production** : Configurez les domaines autoris√©s dans Lengo Pay
3. **Monitoring** : Surveillez les logs pour d√©tecter les √©checs
4. **Backup** : Sauvegardez r√©guli√®rement les donn√©es de paiement
5. **Support** : Contactez le support Lengo Pay pour toute question technique

---

L'API de paiement BraPrime est maintenant pr√™te √† √™tre utilis√©e ! üéâ 